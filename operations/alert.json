{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Operations: Alert topic, a owlhub template",
    "Parameters": {
        "Email": {
            "Description": "Optional email address that will receive alerts",
            "Type": "String",
            "Default": ""
        },
        "HttpEndpoint": {
            "Description": "Optional HTTP endpoint that will receive alerts via POST request.",
            "Type": "String",
            "Default": ""
        },
        "HttpsEndpoint": {
            "Description": "Optional HTTPs endpoint that will receive alerts via POST requests",
            "Type": "String",
            "Default": ""
        },
        "FallbackEmail": {
            "Description": "Optional email address that will receive alerts if alerts can not be delivered.",
            "Type": "String",
            "Default": ""
        }
    },
    "Conditions": {
        "HasEmail": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "Email"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasHttpEndpoint": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "HttpEndpoint"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasHttpsEndpoint": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "HttpsEndpoint"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasFallbackEmail": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "FallbackEmail"
                        },
                        ""
                    ]
                }
            ]
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Alert Parameters"
                    },
                    "Parameters": [
                        "Email",
                        "HttpEndpoint",
                        "HttpsEndpoint"
                    ]
                },
                {
                    "Label": {
                        "default": "Fallback Parameters"
                    },
                    "Parameters": [
                        "FallbackEmail"
                    ]
                }
            ]
        },
        "AWS::CloudFormation::Designer": {
            "fc24258f-f547-46a0-920e-8f08bd7dbe9c": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -120,
                    "y": 280
                },
                "z": 0,
                "embeds": []
            },
            "e6f0ef39-c04f-43c1-908a-ce25fc05b5b0": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -120,
                    "y": 380
                },
                "z": 0,
                "embeds": [],
                "isassociatedwith": [
                    "fc24258f-f547-46a0-920e-8f08bd7dbe9c"
                ]
            },
            "94c5fb38-8ccc-468b-8de0-a2d9e1d7c8aa": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -320,
                    "y": 280
                },
                "z": 0,
                "embeds": []
            },
            "32f5f496-1139-48e2-85e6-e9057c269ebf": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -220,
                    "y": 280
                },
                "z": 0,
                "embeds": []
            },
            "eaf81248-5408-4ba4-add6-e65303397e03": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -10,
                    "y": 280
                },
                "z": 0,
                "embeds": [],
                "isassociatedwith": [
                    "fc24258f-f547-46a0-920e-8f08bd7dbe9c"
                ]
            },
            "65d7c2f3-139c-45ee-a600-0f0a2bfd478d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -10,
                    "y": 370
                },
                "z": 0,
                "embeds": [],
                "isassociatedwith": [
                    "fc24258f-f547-46a0-920e-8f08bd7dbe9c"
                ]
            },
            "dc26caa0-f52d-4422-b5da-50b3ce8774f2": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -10,
                    "y": 190
                },
                "z": 0,
                "embeds": [],
                "isassociatedwith": [
                    "fc24258f-f547-46a0-920e-8f08bd7dbe9c"
                ]
            },
            "b66a7338-486c-4765-8e86-1ab56721cfbe": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -320,
                    "y": 380
                },
                "z": 0,
                "embeds": []
            }
        }
    },
    "Outputs": {
        "TemplateID": {
            "Description": "owlhub template id.",
            "Value": "operations/alert"
        },
        "TemplateVersion": {
            "Description": "owlhub template version.",
            "Value": "1.0.0"
        },
        "StackName": {
            "Description": "Stack name.",
            "Value": {
                "Fn::Sub": "${AWS::StackName}"
            }
        },
        "TopicARN": {
            "Description": "The ARN of the alert topic.",
            "Value": {
                "Ref": "Topic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-TopicARN"
                }
            }
        }
    },
    "Resources": {
        "Topic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "fc24258f-f547-46a0-920e-8f08bd7dbe9c"
                }
            }
        },
        "TopicPolicy": {
            "Type": "AWS::SNS::TopicPolicy",
            "Properties": {
                "PolicyDocument": {
                    "Id": "Id1",
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Sid1",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "events.amazonaws.com",
                                    "budgets.amazonaws.com",
                                    "rds.amazonaws.com",
                                    "s3.amazonaws.com"
                                ]
                            },
                            "Action": "sns:Publish",
                            "Resource": {
                                "Ref": "Topic"
                            }
                        },
                        {
                            "Sid": "Sid2",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": "*"
                            },
                            "Action": "sns:Publish",
                            "Resource": {
                                "Ref": "Topic"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "AWS:SourceOwner": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "Sid3",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ses.amazonaws.com"
                            },
                            "Action": "sns:Publish",
                            "Resource": {
                                "Ref": "Topic"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "AWS:Referer": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Topics": [
                    {
                        "Ref": "Topic"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "e6f0ef39-c04f-43c1-908a-ce25fc05b5b0"
                }
            }
        },
        "FallbackTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "94c5fb38-8ccc-468b-8de0-a2d9e1d7c8aa"
                }
            }
        },
        "NumberOfNotificationsFailedTooHighAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "Alerts could not be delivered",
                "Namespace": "AWS/SNS",
                "MetricName": "NumberOfNotificationsFailed",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 1,
                "ComparisonOperator": "GreaterThanThreshold",
                "Threshold": 0,
                "AlarmActions": [
                    {
                        "Ref": "FallbackTopic"
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "TopicName",
                        "Value": {
                            "Fn::GetAtt": [
                                "Topic",
                                "TopicName"
                            ]
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "32f5f496-1139-48e2-85e6-e9057c269ebf"
                }
            }
        },
        "EmailSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "Endpoint": {
                    "Ref": "Email"
                },
                "Protocol": "email",
                "TopicArn": {
                    "Ref": "Topic"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "eaf81248-5408-4ba4-add6-e65303397e03"
                }
            },
            "Condition": "HasEmail"
        },
        "HttpEndpointSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "DeliveryPolicy": {
                    "healthyRetryPolicy": {
                        "minDelayTarget": 1,
                        "maxDelayTarget": 60,
                        "numRetries": 100,
                        "numNoDelayRetries": 0,
                        "backoffFunction": "exponential"
                    },
                    "throttlePolicy": {
                        "maxReceivesPerSecond": 1
                    }
                },
                "Endpoint": {
                    "Ref": "HttpEndpoint"
                },
                "Protocol": "http",
                "TopicArn": {
                    "Ref": "Topic"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "65d7c2f3-139c-45ee-a600-0f0a2bfd478d"
                }
            },
            "Condition": "HasHttpEndpoint"
        },
        "HttpsEndpointSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "DeliveryPolicy": {
                    "healthyRetryPolicy": {
                        "minDelayTarget": 1,
                        "maxDelayTarget": 60,
                        "numRetries": 100,
                        "numNoDelayRetries": 0,
                        "backoffFunction": "exponential"
                    },
                    "throttlePolicy": {
                        "maxReceivesPerSecond": 1
                    }
                },
                "Endpoint": {
                    "Ref": "HttpsEndpoint"
                },
                "Protocol": "https",
                "TopicArn": {
                    "Ref": "Topic"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "dc26caa0-f52d-4422-b5da-50b3ce8774f2"
                }
            },
            "Condition": "HasHttpsEndpoint"
        },
        "FallbackEmailSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "Endpoint": {
                    "Ref": "FallbackEmail"
                },
                "Protocol": "email",
                "TopicArn": {
                    "Ref": "FallbackTopic"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b66a7338-486c-4765-8e86-1ab56721cfbe"
                }
            },
            "Condition": "HasFallbackEmail"
        }
    }
}
